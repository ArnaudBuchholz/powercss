#!/bin/bash

# See http://www.davidpashley.com/articles/writing-robust-shell-scripts.html

# exit when encountering undeclared variables
set -u;

# exit when encountering a non-zero exit status
# (disabled here as we do are own checking)
# set -e;

# Adjust for links
LINK_PATH=$(readlink -f -- "${0}");
BIN_PATH=$( cd ${LINK_PATH%/*} && echo $PWD ); # absolute path to this bin
ROOT_DIR=$(cd "$(git rev-parse --show-toplevel)" && pwd );
NODE_EXEC=$(which node);
JSLINT_EXEC="${ROOT_DIR}/node_modules/jslint/bin/jslint.js";
NODEUNIT_EXEC="${ROOT_DIR}/node_modules/nodeunit/bin/nodeunit";
NODEUNIT_FILE="${ROOT_DIR}/test/t.js";
TMP_FILE="/tmp/git-pre-commit.tmp";

if [ ! -x "${NODE_EXEC}" ]; then
  echo "Node not found.  Please install nodejs and ensure it is "
  echo " found in your PATH environment variable."
  exit 1;
fi

echo "${JSLINT_EXEC} ${NODEUNIT_EXEC}";
if [ ! -x "${JSLINT_EXEC}" ] || [ ! -x "${NODEUNIT_EXEC}" ]; then
  echo "Development libraries not found."
  echo "Please execute the following command: "
  echo "  cd ${ROOT_DIR}; npm install ";
  exit 1;
fi

echo;
echo "JSLint test of updated or new *.js files ...";
echo "  We ignore vendor libraries in .../vendor/...";
git status \
  | grep '.js$' \
  | grep -v '/vendor/' \
  | grep '^\s\+\(modified\|new file\)' \
  | cut -d ":" -f 2- \
  | while read LINE; do
      echo -en "  Check ${LINE}: ... "
      CHECK_STR=$(${JSLINT_EXEC} ${LINE});
      CHECK_CODE=$?;
      echo "${CHECK_CODE}"
      if [ "${CHECK_CODE}" -gt 0 ]; then
        echo "${LINE} JSLint check FAILED";
        echo "${CHECK_STR}";
      else
        echo "pass";
      fi;
    done \
  | tee "${TMP_FILE}";

echo "JSLint test complete";
if grep -s 'FAIL' "${TMP_FILE}"; then
  echo "FAIL: JSLint checks did not pass.";
  echo "  Please use jslint to test the problem files and ";
  echo "  commit again once they pass the check.";
  rm "${TMP_FILE}";
  exit 1;
fi

rm "${TMP_FILE}";
echo;

echo "Running regression tests"

"${NODEUNIT_EXEC}" "${NODEUNIT_FILE}"
exit $?;

